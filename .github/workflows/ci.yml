# This workflow conducts CI testing across all of VICE's branches.

name: GitHub CI

on: [push, pull_request]

jobs:
  build:
    name: ${{ matrix.os }} | Python ${{ matrix.python-version }} | openmp = ${{ matrix.openmp }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-10.15]
        compiler: [gcc-10, clang]
        openmp: [true, false]
        python-version:
          - "3.7"
          - "3.8"
          - "3.9"
          - "3.10"

        exclude:
          - os: macos-10.15
            compiler: gcc-10

          - os: ubuntu-latest
            compiler: clang

    env:
      COMPILER: ${{ matrix.compiler }}
      CFLAGS: "-fPIC -Wsign-conversion -Wsign-compare"
      LINKFLAGS: ""

    steps:
        # Extend the environment variables for subsequent steps if necessary
      - name: Setup OpenMP
        if: matrix.openmp
        run: |
          if [[ $OSTYPE == *"darwin"* ]] ; then
            brew install libomp
            echo "CFLAGS=$CFLAGS -Xpreprocessor -fopenmp" >> $GITHUB_ENV
            echo "LINKFLAGS=$LINKFLAGS -lomp" >> $GITHUB_ENV
          elif [[ $OSTYPE == *"linux-gnu"* ]] ; then
            echo "CFLAGS=$CFLAGS -fopenmp" >> $GITHUB_ENV
          fi

      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install Cython>=0.29.21

      - name: Display Environment Variables
        shell: bash
        run: |
          echo "PATH: " $PATH
          echo "COMPILER: " `which $COMPILER`
          echo "COMPILER VERSION: " `$COMPILER --version`
          echo "PYTHON: " `which python`
          echo "PYTHON VERSION: " `python --version`
          echo "MAKE: " `which make`
          echo "MAKE VERSION: " `make --version`
          echo "CFLAGS: " $CFLAGS
          echo "LINKFLAGS: " $LINKFLAGS

      - name: Compile and Install
        shell: bash
        run: |
          make CC=$COMPILER CFLAGS="$CFLAGS" LINKFLAGS="$LINKFLAGS"
          if [[ $CFLAGS == *"-fopenmp"* ]] ; then
            python setup.py build install --enable-openmp 2> err.out
          else
            python setup.py build install 2> err.out
          fi
          make clean

      - name: Display Compiler Warnings
        if: always()
        shell: bash
        run: |
          if [ -f "err.out" ] ; then
            cat err.out
            rm -f err.out
          fi

      # After tests, rename the output log if this is ran with openMP
      - name: Tests
        shell: bash
        run: |
          make tests
          if [[ $CFLAGS == *"-fopenmp"* ]] ; then
            LOGFILE=$(ls ./vice | grep .log)
            mv ./vice/$LOGFILE ./vice/openmp_$LOGFILE
          fi

      # Tests leave behind a test_<platform>_<version>.log file under ./vice
      - name: Upload Test Log
        uses: actions/upload-artifact@v2
        with:
          name: testlogs
          path: ./vice/*.log

      - name: Clean Source Tree
        shell: bash
        run: |
          make clean

